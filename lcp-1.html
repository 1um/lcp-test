<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>LCP Test: Fetch Delay</title>
    <script>
      (function () {
        if (/exitEarly=true/.test(window.location.search)) {
          return console.warn("[LCP Test] Exit early via URL parameter");
        }

        const params = new URLSearchParams(window.location.search);
        const fetchCount = parseInt(params.get("fetchCount")) || 5;
        const timeoutMs = parseInt(params.get("timeoutMs")) || 1000;
        const fetchUrl =
          "https://edge.cofra.me/?config=%257B%2522projectId%2522%253A%252267eef89169343b193adabcd3%2522%252C%2522startTime%2522%253A1752256578640%252C%2522timeoutMs%2522%253A1000%252C%2522currentUrl%2522%253A%2522https%253A%252F%252Fthrivemarket.com%252F%2522%252C%2522waitForHydration%2522%253Atrue%257D";

        const style = document.createElement("style");
        style.innerHTML = "body { opacity: 0 !important; }";
        document.head.appendChild(style);

        const show = () => {
          style.remove();
          console.log("[LCP Test] Showing content");
        };

        document.addEventListener("onShow", show);

        setTimeout(() => {
          console.log("[LCP Test] Timeout reached");
          show();
        }, timeoutMs);

        const runParallelFetches = async () => {
          try {
            const fetches = [];
            for (let i = 0; i < fetchCount; i++) {
              console.log(`Queuing fetch ${i + 1}/${fetchCount}`);
              fetches.push(fetch(fetchUrl));
            }
            await Promise.all(fetches);
            console.log("[LCP Test] All fetches done. Dispatching onShow");
            document.dispatchEvent(new Event("onShow"));
          } catch (e) {
            console.error("[LCP Test] Fetch error, showing anyway", e);
            show();
          }
        };

        runParallelFetches();
      })();
    </script>
  </head>
  <body style="font-family: sans-serif; max-width: 600px; margin: 4rem auto; padding: 1rem; line-height: 1.5;">
    <h1>âœ… Demo: LCP Fetch Simulation</h1>
    <p>
      The page stays hidden until the <code>onShow</code> event fires, which occurs after a timeout or all fetches finished.
      <br />
      Timeout should control LCP max impact, but simulated LCP is growing with fetch count.
    </p>
    <h2>Example URLs</h2>
    <ul>
      <li><a href="/lcp-test/lcp-1?exitEarly=true">/lcp-test/lcp-1?exitEarly=true</a></li>
      <li><a href="/lcp-test/lcp-1?fetchCount=5">/lcp-test/lcp-1?fetchCount=5</a></li>
      <li><a href="/lcp-test/lcp-1?fetchCount=10">/lcp-test/lcp-1?fetchCount=10</a></li>
      <li><a href="/lcp-test/lcp-1?fetchCount=40">/lcp-test/lcp-1?fetchCount=40</a></li>
    </ul>
  </body>
</html>
